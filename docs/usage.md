# Usage

Automate DigitalOcean droplet creation and website deployment with CyberPanel.

## Creating a New Droplet

Follow these steps to create and configure a new droplet:

1. Configure your Digital Ocean API credentials, and set the image ID, in `droplet-manager.config.php`:
```php
return [
    'digitalocean' => [
        'token'    => 'your_do_token',
        'image_id' => 'litespeedtechnol-cyberpanel-20-04',
    ],
    // ... other configurations
];
```

2. Create a new droplet using the provided example script. See [`examples/createDroplet.php`](../examples/createDroplet.php):
```php
// Create a new Manager instance
$manager = new Manager(null, 'config/droplet-manager.config.php', null);

// Set the parameters for the new droplet
$dropletName = 'test-droplet-' . uniqid();
$region      = 'nyc3';
$size        = 's-1vcpu-1gb';

// Create the droplet
$dropletInfo = $manager->createDroplet($dropletName, $region, $size);

var_dump($dropletInfo);
```

3. After running the script, wait for an email from Digital Ocean containing:
   - Your droplet's IP address
   - A temporary root password

4. Log into your new droplet. You can use the Digital Ocean droplet console, or SSH (`ssh root@your_droplet_ip`). And set up credentials.
   - You'll be prompted to enter the temporary password
   - You'll then be required to set a new root password
   - You should update the system as prompted (may take a few minutes)

5. Retrieve important passwords from the droplet:
   - CyberPanel admin password: `cat /root/.litespeed_password`
   - MySQL root password: `cat /root/.db_password`

6. Update your configuration file with the new droplet's credentials. Replace `your-droplet-name` with the name you used when creating the droplet. And set the `server_ip` to the IP address you received in the email.

`root_password` is the new root password you set when you first logged in. `mysql_root_password` is the password from the `/root/.db_password` file. `cyberpanel_password` is the password from the `/root/.litespeed_password` file.
```php
return [
    // ... existing config ...
    'your-droplet-name' => [
        'server_ip'           => 'your_new_droplet_ip',
        'root_password'       => 'your_new_root_password',
        'mysql_root_password' => 'password_from_db_password_file',
        'cyberpanel_port'     => 8090,
        'cyberpanel_admin'    => 'admin',
        'cyberpanel_password' => 'password_from_litespeed_password_file',
    ],
];
```

Your droplet is now ready for use with the Droplet Manager library.

### Configure the Droplet

See [`examples/configureDroplet.php`](../examples/configureDroplet.php). This method will configure the droplet.

The `configureDroplet()` method performs some server setup:
- System utilities (aliases, screen, nano)
- CyberPanel updates and API configuration
- Install PHP and LiteSpeed PHP versions and extensions
- MySQL remote access configuration and firewall rules
- WP-CLI installation

In the code below, `your-droplet-name` is the name of the droplet. And the associated section in the config file is `'your-droplet-name' => [ ... ]`.

```php
// Create a new Manager instance
$manager = new Manager('your-droplet-name', 'config' . DIRECTORY_SEPARATOR . 'droplet-manager.config.php', null);

// Optionally enable verbose and debug output
//$manager->setVerbose(true);
//$manager->setDebug(true);

// Configure the droplet with custom settings

$result = $manager->configureDroplet(
    updateCyberPanel: true,
    updateOs: true,
    pipInstall: true,
    updateApt: true,
    phpDisplayErrors: false,
    mysqlPort: 3306
);
var_dump($result);
```

### Create a User

Create a new CyberPanel user (website Owner). This is not a Linux system user.

```php
$result = $manager->connectCyberLink()->createUser(
    firstName: 'John',
    lastName: 'Doe',
    email: 'john.doe@gmail.com',
    username: 'johndoe',
    password: 'secure_password',
    websitesLimit: 0,
    debug: false
);
var_dump($result);
```

### Setup Website

See [`examples/setupWebsite.php`](../examples/setupWebsite.php). This method will create a new website.

The `username` parameter is the CyberPanel Owner (from CyberPanel > List Users), not the Linux system username.

The Linux username is auto-generated by CyberPanel, and its password must be set separately for SSH access.

**Note:** CyberPanel requires **unique database usernames per website**. If you're setting up multiple websites, use different usernames for each.

```php
// Create a new website
$domainName = 'examplesite.com';
$username = substr(preg_replace('/[^a-z0-9]/', '', strtolower($domainName)), 0, 16);
$manager->setupWebsite(
    domainName: $domainName,
    debug: false,
    websiteEmail: 'admin@' . $domainName,
    username: $username,
    password: 'secure_password'
);
```

### Delete Website

See [`examples/deleteWebsite.php`](../examples/deleteWebsite.php). This method will delete a website.

If you have just created a website. You may need to wait a minute before being able to delete it.

```php
// Delete a website
$manager->deleteWebsite('examplesite.com');
```

### Server Information

```php
// List websites
$websites = $manager->getWebsites();
echo "Websites:\n";
print_r($websites);

// List users
$users = $manager->getUsers();
echo "Users:\n";
print_r($users);

// List databases for each website
foreach ($websites as $website) {
    echo "Databases for {$website}:\n";
    $databases = $manager->getDatabases($website);
    print_r($databases);
}
```

### DNS Management

See [`examples/updateNameservers.php`](../examples/updateNameservers.php).

For Namecheap, you must whitelist the IP of the server this script is running on in your Namecheap Dashboard. Go to `Account>Profile>Tools>Business & Dev Tools>Namecheap API Access>Manage`. And edit `Whitelisted IPs`.

```php
// Update nameservers (Namecheap)
$manager->updateNameserversNamecheap('examplesite.com');

// Update nameservers (GoDaddy)
$manager->updateNameserversGodaddy('examplesite.com');
```